name: ðŸš€ Flutter Build & Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_version_bump:
        description: "Skip auto version bump?"
        required: false
        default: "false"
        type: boolean

jobs:
  setup-and-verify:
    name: ðŸ”§ Setup & Verify
    runs-on: ubuntu-latest
    outputs:
      flutter_version: ${{ steps.versions.outputs.flutter_version }}
      dart_version: ${{ steps.versions.outputs.dart_version }}
      project_version: ${{ steps.versions.outputs.project_version }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Get versions
        id: versions
        run: |
          FLUTTER_VERSION=$(flutter --version | grep -o "Flutter [0-9.]*" | cut -d' ' -f2)
          DART_VERSION=$(dart --version 2>/dev/null | grep -o "version: [0-9.]*" | cut -d' ' -f2 || echo "unknown")
          PROJECT_VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk -F' ' '{print $2}')

          echo "flutter_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT
          echo "dart_version=$DART_VERSION" >> $GITHUB_OUTPUT
          echo "project_version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

          echo "âœ… Flutter: $FLUTTER_VERSION"
          echo "âœ… Dart: $DART_VERSION"
          echo "âœ… Project Version: $PROJECT_VERSION"

  build-android:
    name: ðŸ¤– Build Android APK
    runs-on: ubuntu-latest
    needs: setup-and-verify

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: |
          flutter build apk --release --dart-define=APP_ENV=production --dart-define=APP_VERSION=${{ needs.setup-and-verify.outputs.project_version }}

      - name: Generate APK name
        id: apk_name
        run: |
          VERSION=${{ needs.setup-and-verify.outputs.project_version }}
          FILENAME_VERSION=$(echo $VERSION | sed 's/+/_/g')
          echo "APK_NAME=manong-app-v$FILENAME_VERSION.apk" >> $GITHUB_ENV
          cp build/app/outputs/flutter-apk/app-release.apk "$APK_NAME"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: ${{ env.APK_NAME }}
          retention-days: 7

  build-ios:
    name: ðŸŽ Build iOS IPA
    runs-on: macos-latest
    needs: setup-and-verify

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1.0"

      - name: Install dependencies
        run: |
          flutter pub get
          cd ios
          pod install

      - name: Build IPA
        run: |
          flutter build ios --release --no-codesign --dart-define=APP_ENV=production --dart-define=APP_VERSION=${{ needs.setup-and-verify.outputs.project_version }}

      - name: Package IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -q -r ../../../app.ipa Payload
          cd ../../..

      - name: Generate IPA name
        id: ipa_name
        run: |
          VERSION=${{ needs.setup-and-verify.outputs.project_version }}
          FILENAME_VERSION=$(echo $VERSION | sed 's/+/_/g')
          echo "IPA_NAME=manong-app-v$FILENAME_VERSION.ipa" >> $GITHUB_ENV
          mv app.ipa "$IPA_NAME"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: ${{ env.IPA_NAME }}
          retention-days: 7

  auto-version:
    name: ðŸ“ˆ Auto Version Bump
    runs-on: ubuntu-latest
    needs: [setup-and-verify, build-android, build-ios]
    if: ${{ github.event_name == 'push' && !github.event.inputs.skip_version_bump }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk -F' ' '{print $2}')
          BASE_VERSION=$(echo $CURRENT_VERSION | awk -F'+' '{print $1}')
          BUILD_NUMBER=$(echo $CURRENT_VERSION | awk -F'+' '{print $2}')

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Increment build number
        run: |
          if [ -z "${{ steps.version.outputs.build_number }}" ]; then
            NEW_VERSION="${{ steps.version.outputs.base_version }}+1"
          else
            NEW_BUILD=$(( ${{ steps.version.outputs.build_number }} + 1 ))
            NEW_VERSION="${{ steps.version.outputs.base_version }}+$NEW_BUILD"
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          sed -i "s/version: ${{ steps.version.outputs.current_version }}/version: $NEW_VERSION/" pubspec.yaml

      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pubspec.yaml
          git commit -m "chore: bump version to ${{ env.NEW_VERSION }} [skip ci]"
          git push
          echo "Updated to version: ${{ env.NEW_VERSION }}"

  create-release:
    name: ðŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, auto-version]
    if: success()

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get release info
        id: release_info
        run: |
          # Get current version
          if [ -n "${{ env.NEW_VERSION }}" ]; then
            VERSION="${{ env.NEW_VERSION }}"
          else
            VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk -F' ' '{print $2}')
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: "Manong App v${{ steps.release_info.outputs.version }}"
          body: |
            # ðŸš€ Manong Application Release v${{ steps.release_info.outputs.version }}

            **Build Date:** $(date '+%Y-%m-%d %H:%M:%S')

            ## ðŸ“¦ What's Included

            - **Android APK**: `manong-app-v$(echo ${{ steps.release_info.outputs.version }} | sed 's/+/_/g').apk`
            - **iOS IPA**: `manong-app-v$(echo ${{ steps.release_info.outputs.version }} | sed 's/+/_/g').ipa`

            ## ðŸ”§ Installation Notes

            ### Android
            1. Download the APK file
            2. Allow installation from unknown sources
            3. Install and open

            ### iOS
            1. Requires sideloading via AltStore or TestFlight
            2. May need to trust developer in Settings

            ---
            *Auto-generated release*
          draft: false
          prerelease: false
          files: |
            artifacts/android-release/*
            artifacts/ios-release/*
